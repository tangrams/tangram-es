Developing the Tangram iOS SDK
==============================

This page is for those who intend to modify Tangram ES itself, not just use it in another application.

## Don't commit code signing changes ##

When building and running the demo application on an iOS device, you will likely need to modify the "App ID" and "Development Team" values in the Xcode project in order to sign the application package correctly because Apple mandates that an App ID can only be used by one Development Team. This is a good security practice, but since the App ID and Developer Team values are embedded in the Xcode project data, there is no way for each developer working with the repository to use their App ID / Developer Team values without modifying the Xcode project files that are checked into source control.

This can be disruptive to a git workflow because git will show the Xcode project file as modified. To work with a clean source tree, you should let git assume there were no changes to the demo Xcode project by running this command once:
```
git update-index --assume-unchanged platforms/ios/demo/TangramDemo.xcodeproj/project.pbxproj
```
[Source](https://stackoverflow.com/questions/21756531/git-ignore-local-changes-to-portions-of-tracked-files)

## Always run builds from the Xcode workspace ##

The Xcode workspace that contains both the demo app project and the framework project uses specific build location settings to ensure that build products for both the framework and demo app are placed in the right locations and are able to build together successfully. If you try to open the demo project separately and build it, the build will probably fail or link against a "stale" version of the framework.

### Background on the Xcode workspace setup ###

We use an Xcode workspace to group the framework and demo projects together so that the framework can be built and debugged along with the demo app as a dependency. The framework project is most convenient to generate through CMake, since it is comprised mostly of the cross-platform C++ core library and its dependencies. The demo app project could also be generated through CMake, but configuring an iOS application with an embedded, code-signed binary framework is complex and fragile with CMake. Furthermore, unlike the core library the demo app has no need for a platform-agnostic build configuration. Therefore it is simplest to use a "hand made" Xcode project to build the demo app. The Xcode workspace allows the demo project to reference the CMake-generated framework project as a dependency. This makes running and debugging both projects together very easy!

Building a project through an Xcode workspace behaves a little differently from building the project on its own (see [Apple's documentation](https://developer.apple.com/library/archive/featuredarticles/XcodeConcepts/Concept-Workspace.html#//apple_ref/doc/uid/TP40009328-CH7-SW1) for a thorough explanation). By default, a workspace overrides the build output locations of the individual projects in it, placing the output for all projects into a separate, shared build folder instead. This causes build errors for projects generated by CMake. CMake hard-codes the absolute paths of build products like library dependencies into the Xcode project. Link flags in the project have those same paths hard-coded as well, so if build outputs are relocated by an Xcode workspace the link commands will fail to find the libraries at the paths in the project.

To overcome this, we use a workspace setting that keeps build products in the locations specified by their original projects. This can be set in Xcode by opening a workspace, then navigating to _File_ > _Workspace Settings_ in the menu bar, then clicking _Advanced..._, then choosing the _Legacy_ option.

This setting is stored per-user in the workspace data, located in `Tangram.xcworkspace/xcuserdata/$USER.xcuserdatad/WorkspaceSettings.xcsettings` where `$USER` is the current user name. Since this path is different for every user, we cannot track this file in git. Instead, we keep a file that stores these settings in `platforms/ios/WorkspaceSettings.xcsettings` and we copy this file into the appropriate location for each user as a step in the `make cmake-ios` rule in our `Makefile`.

## CMake can configure most Xcode settings ##

We use CMake to specify build configurations in Tangram ES because of its portability across platforms. However when setting up builds targeting iOS, we can take advantage of the fact that we will only use CMake to generate Xcode projects. CMake configures the build settings on a target in a generated XCode project from the target `PROPERTIES` in CMake. These settings are string-based key-value pairs. In an open Xcode project, you can use the **Quick Help Inspector** on the right-side panel to determine the key name for any build setting. This key is used in the text-file representation of the Xcode project data (a `pbxproj` file).

![Xcode build settings in a project window and the pbxproj file](/images/xcode-attributes.png)

In CMake you can set the value of these build settings by setting a property on a library or executable target with the name `XCODE_ATTRIBUTE_<BUILD_SETTING_NAME>` (this pattern is documented in the CMake manual [here](https://cmake.org/cmake/help/v3.12/prop_tgt/XCODE_ATTRIBUTE_an-attribute.html)). For example, to set the build setting from the image above that is declared as `IPHONEOS_DEPLOYMENT_TARGET` for a target named `myIosTarget`, your CMake file should contain:

```cmake
set_target_properties(myIosTarget PROPERTIES XCODE_ATTRIBUTE_IPHONEOS_DEPLOYMENT_TARGET "9.3")
```

Some build configurations are more easily applied through Xcode settings, and some are only relevant when Xcode is the target IDE.

## Fix missing symbols when profiling in Instruments ##

After running the Time Profiler in Xcode's Instruments you might see traces with memory addresses instead of function names, like in the image below:

![Instruments trace with missing symbols](/images/instruments-missing-symbols.png)

For each Instruments run where function names are missing use the following steps to locate the symbols that Instruments needs to show the names correctly.

After collecting data from a run and stopping the Time Profiler, go to `File` > `Symbols...`

In the symbols pane that appears, select `TangramMap` in the menu on the left and then press the folder icon next to the binary path to choose the correct binary file.

![Instruments symbols pane](/images/instruments-locate-binary.png)

The correct binary file is the file named `TangramMap` in the directory shown in the file chooser that appears (located within the tangram-es repository at `build/ios/Release-iphoneos/TangramMap.framework/TangramMap`).  After choosing the binary file, press `Done` to close the symbols pane and the function names will appear correctly in your Time Profiler trace.
